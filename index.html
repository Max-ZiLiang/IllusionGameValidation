<head>
    <!-- Customize the title! -->
    <title>Illusion Game</title>
    <!-- jsPsych Scripts -->
    <script src="https://unpkg.com/jspsych@7.2.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.1"></script>
    <!-- Other modules -->
    <script src="https://realitybending.github.io/JSmisc/misc/utils.js"></script>
    <!-- Load stimuli -->
    <script src="stimuli/stimuli.js"></script>
    <script src="experiment.js"></script>
    <script src="population_scores.js"></script>
    <!-- CSS -->
    <link href="https://unpkg.com/jspsych@7.2.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        /*Hide scrollbar while keeping it functional */
        body {
            overflow-y: scroll;
            overflow-x: flow;
        }

        Body::-webkit-scrollbar {
            display: none
        }
    </style>
</head>

<body></body>



<script>



    /* ----------------- Initialize experiment ----------------- */
    var timeline = []
    var jsPsych = initJsPsych({
        show_progress_bar: true,
        message_progress_bar: "Completion",
        // exclusions: { min_width: 800, min_height: 600 }, /* exclude browsers that are not at least 800x600 pix */
        //  on_interaction_data_update: function (data) {console.log(JSON.stringify(data))}, /* record browser interactions */
        on_finish: function () {
            jsPsych.data.displayData("json")
            jsPsych.data
                .get()
                .localSave(
                    "json",
                    `${
                        jsPsych.data.get().values()[0]["participant_id"]
                    }_IllusionGame.json`
                )
        },
    })

    /* ----------------- Experiment  ----------------- */

    // Participant information
    var participant_info = {
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: "Enter the participant's ID:",
                placeholder: "S00",
                name: "Participant_ID",
            },
        ],
        data: {
            screen: "participant_info",
            version: "1.0",
            date: new Date().toLocaleDateString("fr-FR"),
            time: new Date().toLocaleTimeString("fr-FR"),
        },
        on_finish: function () {
            jsPsych.data.addProperties({
                participant_id: jsPsych.data.get().last().values()[0]["response"][
                    "Participant_ID"
                ],
            })
        },
    }
    // timeline.push(participant_info)

    // Fullscreen mode
    timeline.push({
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        delay_after: 0,
    })


    // General Instructions
    var general_instructions = {
        type: jsPsychHtmlButtonResponse,
        choices: ["Let's play!"],
        stimulus:
            "<p><b>The Illusion Game</b></p>" +
            "<p>In this reaction-time game, you will need to be <b>as fast as possible</b> and make correct responses by resisting different visual illusions.</p>" +
            "<p>We will show you examples of each illusion before each block.</p>" +
            "<p>Remember, your goal is to be as <b>fast</b> and <b>accurate</b> as possible. Good luck!</p>",
        data: { screen: "participant_general_instructions" },
    }
    timeline.push(general_instructions)



    // Set experiment variables
    var trial_number = 1 // trial indexing variable starts at 1 for convenience
    var block_number = 1 // block indexing variable

    /* ============================================================== */
    /* ----------------- BLOCK 1: DELBOEUF ILLUSION ----------------- */
    /* ============================================================== */
    var timeline_delboeuf = []

    // Set stimuli (var stimuli is loaded in stimuli/stimuli.js)
    var stimuli_delboeuf = stimuli.filter(
        (stimuli) => stimuli.Illusion_Type === "Delboeuf"
    )

    // Preload images
    timeline_delboeuf.push({
        type: jsPsychPreload,
        trials: stimuli_delboeuf, // Preload images
    })

    // Instructions
    var instructions_delboeuf = {
        type: jsPsychHtmlKeyboardResponse,
        on_start: function () {
            ;(document.body.style.cursor = "none"),
                (document.querySelector(
                    "#jspsych-progressbar-container"
                ).style.display = "none")
        },
        choices: ["enter"],
        stimulus: function () {
            return (
                "<p><b>Part " +
                block_number +
                "</b></p>" +
                "<p>In this part, two red circles will appear side by side on the screen.</p>" +
                "<p>Your task is to select which <b>red circle is bigger</b> in size as fast as you can, without making errors.</p>" +
                "<p>Don't get distracted by the black outlines around the red circles!</p>" +
                "<p>Press <b>the left or the right arrow</b> to indicate where is the biggest <b>red circle.</b></p>" +
                "<div style='float: center'><img src='utils/stimuli_demo/Delboeuf_Demo.png' height='300'></img>" +
                "<p><img src='utils/answer/answer_leftright_keyboard.PNG' height='150'></img></p>" +
                "<p class='small'>In this example, the correct answer is the <b>left arrow</b>.</p></div>" +
                "<p>Are you ready? <b>Press ENTER to start</b></p>"
            )
        },
        post_trial_gap: 500,
    }
    timeline_delboeuf.push(instructions_delboeuf)

    // Set test trials
    var trial_delboeuf = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable("stimulus"),
        choices: ["arrowleft", "arrowright"],
        data: jsPsych.timelineVariable("data"),
        on_finish: function (data) {
            data.prestimulus_duration =
                jsPsych.data.get().last(2).values()[0].time_elapsed -
                jsPsych.data.get().last(3).values()[0].time_elapsed
            // Score the response as correct or incorrect.
            if (data.response != -1) {
                if (
                    jsPsych.pluginAPI.compareKeys(
                        data.response,
                        data.correct_response
                    )
                ) {
                    data.correct = true
                } else {
                    data.correct = false
                }
            } else {
                // code mouse clicks as correct or wrong
                if (data.click_x < window.innerWidth / 2) {
                    // use window.innerHeight for up vs down presses
                    data.response = "arrowleft"
                } else {
                    data.response = "arrowright"
                }
                if (
                    jsPsych.pluginAPI.compareKeys(
                        data.response,
                        data.correct_response
                    )
                ) {
                    data.correct = true
                } else {
                    data.correct = false
                }
            }
            // track block and trial numbers
            data.block = "delboeuf"
            data.illusion_strength = jsPsych.timelineVariable("Illusion_Strength")
            data.illusion_difference = jsPsych.timelineVariable("Difference")
            data.block_number = block_number
            data.trial_number = trial_number
            trial_number += 1
        },
    }

    // link variables in stimuli array with the call to jsPsych.timelineVariable()
    timeline_delboeuf.push({
        timeline: [fixation, trial_delboeuf],
        timeline_variables: stimuli_delboeuf,
        randomize_order: true,
        repetitions: 1,
    })

    // Debriefing Information
    var debrief_delboeuf = {
        type: jsPsychHtmlButtonResponse,
        choices: ["Continue"],
        on_start: function () {
            ;(document.body.style.cursor = "auto"),
                (document.querySelector(
                    "#jspsych-progressbar-container"
                ).style.display = "inline")
        },
        stimulus: function () {
            var results = get_results(
                population_scores["Delboeuf"]["IES_Mean"][0],
                population_scores["Delboeuf"]["IES_SD"][0],
                "delboeuf"
            )
            var show_screen = get_debrief_display(results)
            return (
                show_screen.display_score +
                "<hr>" +
                // // For debugging purposes, show the raw data.
                // show_screen.display_accuracy +
                // "<hr>" +
                // show_screen.display_rt +
                // "<hr>" +
                // //
                show_screen.display_comparison +
                "<hr><p>Can you do better in the next illusion?</p>"
            )
        },
        data: { screen: "block_results" },
        // Reset trial number and update block number
        on_finish: function () {
            block_number += 1
            trial_number = 1
        },
    }
    timeline_delboeuf.push(debrief_delboeuf)

    timeline.push({ timeline: timeline_delboeuf })



    /* ================================================================ */
    /* ----------------- BLOCK 2: EBBINGHAUS ILLUSION ----------------- */
    /* ================================================================ */
    var timeline_ebbinghaus = []

    // Set stimuli (var stimuli is loaded in stimuli/stimuli.js)
    var stimuli_ebbinghaus = stimuli.filter(
        (stimuli) => stimuli.Illusion_Type === "Ebbinghaus"
    )

    // Preload images
    timeline_ebbinghaus.push({
        type: jsPsychPreload,
        trials: stimuli_ebbinghaus, // Preload images
    })

    // Instructions
    var instructions_ebbinghaus = {
        type: jsPsychHtmlKeyboardResponse,
        on_start: function () {
            ;(document.body.style.cursor = "none"),
                (document.querySelector(
                    "#jspsych-progressbar-container"
                ).style.display = "none")
        },
        choices: ["enter"],
        stimulus: function () {
            return (
                "<p><b>Part " +
                block_number +
                "</b></p>" +
                "<p>In this part, two red circles will appear side by side on the screen.</p>" +
                "<p>Your task is to select which <b>red circle is bigger</b> in size as fast as you can, without making errors.</p>" +
                "<p>Don't get distracted by the surrounding black circles around the red circles!</p>" +
                "<p>Press <b>the left or the right arrow</b> to indicate where is the biggest <b>red circle.</b></p>" +
                "<div style='float: center'><img src='utils/stimuli_demo/Ebbinghaus_Demo.png' height='300'></img>" +
                "<p><img src='utils/answer/answer_leftright_keyboard.PNG' height='150'></img></p>" +
                "<p class='small'>In this example, the correct answer is the <b>left arrow</b>.</p></div>" +
                "<p>Are you ready? <b>Press ENTER to start</b></p>"
            )
        },
        post_trial_gap: 500,
    }
    timeline_ebbinghaus.push(instructions_ebbinghaus)


    // Set test trials
    var trial_ebbinghaus = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable("stimulus"),
        choices: ["arrowleft", "arrowright"],
        data: jsPsych.timelineVariable("data"),
        on_finish: function (data) {
            data.prestimulus_duration =
                jsPsych.data.get().last(2).values()[0].time_elapsed -
                jsPsych.data.get().last(3).values()[0].time_elapsed
            // Score the response as correct or incorrect.
            if (data.response != -1) {
                if (
                    jsPsych.pluginAPI.compareKeys(
                        data.response,
                        data.correct_response
                    )
                ) {
                    data.correct = true
                } else {
                    data.correct = false
                }
            } else {
                // code mouse clicks as correct or wrong
                if (data.click_x < window.innerWidth / 2) {
                    // use window.innerHeight for up vs down presses
                    data.response = "arrowleft"
                } else {
                    data.response = "arrowright"
                }
                if (
                    jsPsych.pluginAPI.compareKeys(
                        data.response,
                        data.correct_response
                    )
                ) {
                    data.correct = true
                } else {
                    data.correct = false
                }
            }
            // track block and trial numbers
            data.block = "ebbinghaus"
            data.illusion_strength = jsPsych.timelineVariable("Illusion_Strength")
            data.illusion_difference = jsPsych.timelineVariable("Difference")
            data.block_number = block_number
            data.trial_number = trial_number
            trial_number += 1
        },
    }


    // link variables in stimuli array with the call to jsPsych.timelineVariable()
    timeline_ebbinghaus.push({
        timeline: [fixation, trial_ebbinghaus],
        timeline_variables: stimuli_ebbinghaus,
        randomize_order: true,
        repetitions: 1,
    })

    // Debriefing Information
    var debrief_ebbinghaus = {
        type: jsPsychHtmlButtonResponse,
        choices: ["Continue"],
        on_start: function () {
            ;(document.body.style.cursor = "auto"),
                (document.querySelector(
                    "#jspsych-progressbar-container"
                ).style.display = "inline")
        },
        stimulus: function () {
            var results = get_results(
                population_scores["Ebbinghaus"]["IES_Mean"][0],
                population_scores["Ebbinghaus"]["IES_SD"][0],
                "ebbinghaus"
            )
            var show_screen = get_debrief_display(results)
            return (
                show_screen.display_score +
                "<hr>" +
                // // For debugging purposes, show the raw data.
                // show_screen.display_accuracy +
                // "<hr>" +
                // show_screen.display_rt +
                // "<hr>" +
                // //
                show_screen.display_comparison +
                "<hr><p>Can you do better in the next illusion?</p>"
            )
        },
        data: { screen: "block_results" },
        // Reset trial number and update block number
        on_finish: function () {
            block_number += 1
            trial_number = 1
        },
    }
    timeline_ebbinghaus.push(debrief_ebbinghaus)
    timeline.push({ timeline: timeline_ebbinghaus })

    // /* ----------------- BLOCK 3: MULLERLYER ILLUSION ----------------- */
    // // Instructions
    // var mullerlyer_instructions = {
    // type: jsPsychHtmlButtonResponse,
    // choices: ["Got it!"],
    // stimulus:
    //     "<p>In this experiment, two red lines will appear " +
    //     "on the screen, one on top and one below. </p><p>Your task is to judge which <strong>red</strong> line is longer as fast as you can without making any errors. </p>" +
    //     "<p>Don't let yourself be distracted by the black arrows at the ends of the red lines!</p>" +
    //     "<p>If the <strong>upper horizontal line</strong> is longer, " +
    //     "<strong>click on the upper line</strong> as fast as you can.</p>" +
    //     "<p>If the <strong>lower horizontal line</strong> is longer, <strong>click on the lower line</strong> as fast as you can.</p><hr>" +
    //     "<div style='float: center'><img src='utils/MullerLyer_Demo.png' height='300'></img>" +
    //     "<p><img src='utils/answer/answer_updown_touch.PNG' height='150'></img></p>" +
    //     "<p class='small'>For example, <strong>click on the upper line</strong> here.</p></div>",
    // // }
    // //    },
    // post_trial_gap: 2000,
    // on_finish: function (data) {
    //     trial_number = 1; // reset trial number for next block
    //     block_number += 1;
    // },
    // };

    // // Set stimuli
    // var mullerlyer_stimuli = test_stimuli.filter(
    // (test_stimuli) => test_stimuli.Illusion_Type === "MullerLyer"
    // );

    // // Preload images
    // var mullerlyer_preload = {
    // type: jsPsychPreload,
    // trials: mullerlyer_stimuli, // automatically preload just the images from block_3 trials
    // };

    // // Set test trials
    // var mullerlyer_test = {
    // type: jsPsychImageKeyboardResponse,
    // stimulus: jsPsych.timelineVariable("stimulus"),
    // choices: ["arrowup", "arrowdown"],
    // data: jsPsych.timelineVariable("data"),
    // on_finish: function (data) {
    //     data.prestimulus_duration =
    //     jsPsych.data.get().last(2).values()[0].time_elapsed -
    //     jsPsych.data.get().last(3).values()[0].time_elapsed;
    //     // Score the response as correct or incorrect.
    //     if (data.response != -1) {
    //     if (jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)) {
    //         data.correct = true;
    //     } else {
    //         data.correct = false;
    //     }
    //     } else {
    //     // code mouse clicks as correct or wrong
    //     if (data.click_x < window.innerHeight / 2) {
    //         // use window.innerHeight for up vs down presses
    //         data.response = "arrowdown";
    //     } else {
    //         data.response = "arrowup";
    //     }
    //     if (jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)) {
    //         data.correct = true;
    //     } else {
    //         data.correct = false;
    //     }
    //     }
    //     // track block and trial numbers
    //     data.block = "mullerlyer";
    //     data.illusion_strength = jsPsych.timelineVariable("Illusion_Strength");
    //     data.illusion_difference = jsPsych.timelineVariable("Difference");
    //     data.block_number = block_number;
    //     data.trial_number = trial_number;
    //     trial_number += 1;
    // },
    // };

    // // link variables in stimuli array with the call to jsPsych.timelineVariable()
    // var test_mullerlyer_procedure = {
    // timeline: [fixation, mullerlyer_test],
    // timeline_variables: mullerlyer_stimuli,
    // randomize_order: true,
    // repetitions: 1,
    // };

    // // Debriefing Information
    // var mullerlyer_debrief = {
    // type: jsPsychHtmlButtonResponse,
    // choices: ["Next Illusion"],
    // stimulus: function () {
    //     var results = get_results(
    //     scores["Mullerlyer"]["IES_Mean"][0],
    //     scores["Mullerlyer"]["IES_SD"][0],
    //     "mullerlyer"
    //     );
    //     var show_screen = get_debrief_display(results);
    //     return (
    //     show_screen.display_score +
    //     "<hr>" +
    //     show_screen.display_comparison +
    //     "<hr><p>Can you do better in the next illusion?</p>"
    //     );
    // },
    // on_finish: function (data) {
    //     var results = get_results(
    //     scores["Mullerlyer"]["IES_Mean"][0],
    //     scores["Mullerlyer"]["IES_SD"][0],
    //     "mullerlyer"
    //     );
    //     data.block = "mullerlyer";
    //     data.block_number = block_number;
    //     data.rt_mean = results.mean_reaction_time;
    //     data.rt_mean_correct = results.mean_reaction_time_correct;
    //     data.accuracy = results.accuracy;
    //     data.inverse_efficiency_score = results.inverse_efficiency;
    // },
    // data: { screen: "block_results" },
    // };

    // /* ----------------- BLOCK 4: PONZO ILLUSION ----------------- */
    // // Instructions
    // var ponzo_instructions = {
    // type: jsPsychHtmlButtonResponse,
    // choices: ["Got it!"],
    // stimulus:
    //     "<p>In this experiment, two red lines will appear " +
    //     "on the screen, one on top and one below. </p><p>Your task is to judge which <strong>red</strong> line is longer as fast as you can without making any errors. </p>" +
    //     "<p>Don't let yourself be distracted by the black vertical lines on the sides of the red lines!</p>" +
    //     "If the <strong>upper horizontal line</strong> is longer, " +
    //     "<strong>click on the upper line</strong> as fast as you can.</p>" +
    //     "<p>If the <strong>lower horizontal line</strong> is longer, <strong>click on the lower line</strong> as fast as you can.</p><hr>" +
    //     "<div style='float: center'><img src='utils/Ponzo_Demo.png' height='300'></img>" +
    //     "<p><img src='utils/answer/answer_updown_touch.PNG' height='150'></img></p>" +
    //     "<p class='small'>For example, <strong>click on the upper line</strong> here.</p></div>",
    // //  }
    // //    },
    // post_trial_gap: 2000,
    // on_finish: function (data) {
    //     trial_number = 1; // reset trial number for next block
    //     block_number += 1;
    // },
    // };

    // // Set stimuli
    // var ponzo_stimuli = test_stimuli.filter(
    // (test_stimuli) => test_stimuli.Illusion_Type === "Ponzo"
    // );

    // // Preload images
    // var ponzo_preload = {
    // type: jsPsychPreload,
    // trials: ponzo_stimuli, // automatically preload just the images from block_3 trials
    // };

    // // Set test trials
    // var ponzo_test = {
    // type: jsPsychImageKeyboardResponse,
    // stimulus: jsPsych.timelineVariable("stimulus"),
    // choices: ["arrowup", "arrowdown"],
    // data: jsPsych.timelineVariable("data"),
    // on_finish: function (data) {
    //     data.prestimulus_duration =
    //     jsPsych.data.get().last(2).values()[0].time_elapsed -
    //     jsPsych.data.get().last(3).values()[0].time_elapsed;
    //     // Score the response as correct or incorrect.
    //     if (data.response != -1) {
    //     if (jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)) {
    //         data.correct = true;
    //     } else {
    //         data.correct = false;
    //     }
    //     } else {
    //     // code mouse clicks as correct or wrong
    //     if (data.click_x < window.innerHeight / 2) {
    //         // use window.innerHeight for up vs down presses
    //         data.response = "arrowdown";
    //     } else {
    //         data.response = "arrowup";
    //     }
    //     if (jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)) {
    //         data.correct = true;
    //     } else {
    //         data.correct = false;
    //     }
    //     }
    //     // track block and trial numbers
    //     data.block = "ponzo";
    //     data.illusion_strength = jsPsych.timelineVariable("Illusion_Strength");
    //     data.illusion_difference = jsPsych.timelineVariable("Difference");
    //     data.block_number = block_number;
    //     data.trial_number = trial_number;
    //     trial_number += 1;
    // },
    // };

    // // link variables in stimuli array with the call to jsPsych.timelineVariable()
    // var test_ponzo_procedure = {
    // timeline: [fixation, ponzo_test],
    // timeline_variables: ponzo_stimuli,
    // randomize_order: true,
    // repetitions: 1,
    // };

    // // Debriefing Information
    // var ponzo_debrief = {
    // type: jsPsychHtmlButtonResponse,
    // choices: ["Next Illusion"],
    // stimulus: function () {
    //     var results = get_results(
    //     scores["Ponzo"]["IES_Mean"][0],
    //     scores["Ponzo"]["IES_SD"][0],
    //     "ponzo"
    //     );
    //     var show_screen = get_debrief_display(results);
    //     return (
    //     show_screen.display_score +
    //     "<hr>" +
    //     show_screen.display_comparison +
    //     "<hr><p>Can you do better in the next illusion?</p>"
    //     );
    // },
    // on_finish: function (data) {
    //     var results = get_results(
    //     scores["Ponzo"]["IES_Mean"][0],
    //     scores["Ponzo"]["IES_SD"][0],
    //     "ponzo"
    //     );
    //     data.block = "ponzo";
    //     data.block_number = block_number;
    //     data.rt_mean = results.mean_reaction_time;
    //     data.rt_mean_correct = results.mean_reaction_time_correct;
    //     data.accuracy = results.accuracy;
    //     data.inverse_efficiency_score = results.inverse_efficiency;
    // },
    // data: { screen: "block_results" },
    // };

    /* ----------------- END OF EXPERIMENT ----------------- */
    // Debriefing Information
    var end_experiment = {
        type: jsPsychHtmlButtonResponse,
        choices: ["End"],
        stimulus: function () {
            var results = get_results(
                population_scores["Total"]["IES_Mean"][0],
                population_scores["Total"]["IES_SD"][0]
            )
            var show_screen = get_debrief_display(results, "Final")
            return (
                show_screen.display_score +
                "<hr>" +
                show_screen.display_comparison +
                "<hr><p>Wait for the experimenter to end the session.</p>"
            )
        },
        data: { screen: "final_results" },
    }
    timeline.push(end_experiment)



    // Fullscreen mode
    timeline.push({
        type: jsPsychFullscreen,
        fullscreen_mode: false,
    })

    jsPsych.run(timeline);



</script>

</html>

<!-- /* SAVING DATA FUNCTION ================== */

// function commitToRepo(jsonData, path) {
//     const url = ".netlify/functions/api"

//     // Example:
//     const response = fetch(url, {
//         method: 'POST', // *GET, POST, PUT, DELETE, etc.
//         mode: 'no-cors', // no-cors, *cors, same-origin
//         cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
//         credentials: 'same-origin', // include, *same-origin, omit
//         headers: {
//             'Content-Type': 'application/json'
//         },
//         redirect: 'follow', // manual, *follow, error
//         referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
//         body: JSON.stringify({
//             path: path,
//             data: JSON.stringify(jsonData)
//         }) // body data type must match "Content-Type" header
//     }).then((response) => {
//         console.log(response)
//     })
// } -->