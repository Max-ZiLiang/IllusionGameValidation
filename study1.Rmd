---
title: "Illusion Game Validation (Study 1)"
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---


```{r, echo = FALSE, warning=FALSE, message=FALSE}
options(digits = 3)

cache <- FALSE
fig.width <- see::golden_ratio(7)
fig.height <- 7

knitr::opts_chunk$set(
  collapse = TRUE,
  dpi = 450,
  fig.path = "./figures/",
  fig.width = fig.width,
  fig.height = fig.height
)
```



# Introduction

Behavioural findings regarding the Illusion Game.

# Methods


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggdist)
library(ggside)
library(easystats)
library(patchwork)
library(brms)

df <- read.csv("data/study1.csv") |>
  mutate(
    Date = as.Date(Date),
    Participant = fct_reorder(Participant, Date),
    Screen_Refresh = as.character(Screen_Refresh),
    Illusion_Side = as.factor(Illusion_Side),
    Block = as.factor(Block),
    Education = fct_relevel(Education, "Master", "Bachelor", "High School", "Other")
  )
```

## Exclusions {.tabset}

```{r message=FALSE, warning=FALSE}
# plot(estimate_density(dfraw[dfraw$Participant == "60684f29dbfe1bb2059e5e27_rkqoy", "RT"]))

# Dear participant, thank you for participating in our study. Unfortunately, our system detected multiple issues in your data (such as implausibly short responses, and random-like pattern of answers), which make the data unusable for us. We understand that you might have been in a hurry, or had some other issues, and kindly ask you to return your participation. We hope to open-up more slots in the future would you be interested to participate again. 

outliers <- c(
  # Half of the trials are of very short RT
  # Prolific Status: REJECTED
  "60684f29dbfe1bb2059e5e27_rkqoy",
  # Error rate of 47.9%
  # Prolific Status: RETURN REQUESTED
  "61280140171ec546e87ed8cb_qdlgy",
  # Error rate of 46.2%
  # Prolific Status: RETURN REQUESTED
  "614f36fd81c78b7a125c4262_6ax4g",
  # Error rate of 42.1% and very large RT SD
  # Prolific Status: RETURN REQUESTED
  "5d398380b37ab1000111fac3_2nxxh",
  # Block n2 with very short RTs
  # Prolific Status: RETURNED
  "5e860198a846e30497df5189_6e43s",
  # Error rate of 46.2% and short RTs
  # Prolific Status: RETURN REQUESTED
  "615f319bb341cf2f306d858d_qsaq5"
)
```

We removed `r length(outliers)` participants upon inspection of the average error rage (when close to 50%, suggesting random answers) and/or when the reaction time distribution was implausibly fast. 

For each block, we computed the error rate and, if more than 50%, we discarded the whole block (as it likely indicates that instructions got mixed up, for instance participants were selecting the smaller instead of the bigger circle).

### Error Rate

```{r message=FALSE, warning=FALSE}
dfsub <- df |>
  group_by(Participant) |>
  summarize(
    # n = n(),
    Error = sum(Error) / n(),
    RT_Mean = mean(RT),
    RT_SD = sd(RT),
  ) |>
  ungroup() |>
  arrange(desc(Error))

knitr::kable(dfsub) |> 
  kableExtra::row_spec(which(dfsub$Participant %in% outliers), background  = "#EF9A9A")
```


### Error Rate per Illusion Block

```{r message=FALSE, warning=FALSE}
temp <- df |>
  group_by(Participant, Illusion_Type, Block) |>
  summarize(ErrorRate_per_block = sum(Error) / n()) |>
  ungroup() |> 
  arrange(desc(ErrorRate_per_block))

temp2 <- temp |> 
  filter(ErrorRate_per_block >= 0.5) |> 
  group_by(Illusion_Type, Block) |> 
  summarize(n = n()) |> 
  arrange(desc(n), Illusion_Type) |> 
  ungroup() |> 
  mutate(n_trials = cumsum(n * 56),
         p_trials = n_trials / nrow(df))

# knitr::kable(temp2)

p1 <- temp |>
  estimate_density(at = c("Illusion_Type", "Block")) |>
  ggplot(aes(x = x, y = y)) +
  geom_line(aes(color = Illusion_Type, linetype = Block)) + 
  geom_vline(xintercept = 0.5, linetype = "dashed") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(y = "Distribution", x = "Error Rate") +
  theme_modern()

p2 <- temp2 |> 
  mutate(Block = fct_rev(Block)) |> 
  ggplot(aes(x = Illusion_Type, y = p_trials)) +
  geom_bar(stat="identity", aes(fill = Block)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_continuous(labels = scales::percent, expand = c(0, 0)) +
  labs(y = "Percentage of Trials Removed", x = "Illusion Type") +
  theme_modern() +
  theme(axis.text.x = element_text(angle=45, hjust = 1))

p1 | p2


# Drop
df <- df |>
  group_by(Participant, Illusion_Type, Block) |>
  mutate(ErrorRate_per_block = sum(Error) / n()) |>
  ungroup() |> 
  filter(ErrorRate_per_block < 0.5) |>
  select(-ErrorRate_per_block)

rm(temp, temp2)
```


### Reaction Time Distribution


```{r message=FALSE, warning=FALSE, fig.width=20, fig.height=20}
# RT distribution
p <- estimate_density(df, select = "RT", at = c("Participant", "Block")) |>
  group_by(Participant) |>
  normalize(select = "y") |>
  ungroup() |>
  mutate(color = ifelse(Participant %in% outliers, "red", "blue")) |>
  ggplot(aes(x = x, y = y)) +
  geom_area(data = normalize(estimate_density(df, select = "RT"), select = "y"), alpha = 0.2) +
  geom_line(aes(color = color, group = interaction(Participant, Block), linetype = Block)) +
  geom_vline(xintercept = 2500, linetype = "dashed", color = "red") +
  scale_color_manual(values=c("red"="red", "blue"="blue"), guide = "none") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(xlim = c(0, 3000)) +
  theme_modern() +
  theme(axis.text.y = element_blank()) +
  facet_wrap(~Participant) +
  labs(y = "", x = "Reaction Time (ms)")
p
# ggsave("figures/outliers.png", p, width=20, height=15)

# Filter out
df <- filter(df, !Participant %in% outliers)
```

### Reaction Time per Trial

```{r message=FALSE, warning=FALSE}
p1 <- estimate_density(df, select = "RT", at = "Participant") |>
  group_by(Participant) |>
  normalize(select = "y") |>
  ungroup() |>
  ggplot(aes(x = x, y = y)) +
  geom_area(data = normalize(estimate_density(df, select = "RT"), select = "y"), alpha = 0.2) +
  geom_line(aes(color = Participant, group = Participant)) +
  geom_vline(xintercept = c(150, 3000), linetype = "dashed", color = "red") +
  scale_color_material_d("rainbow", guide = "none") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(xlim = c(0, 3500)) +
  theme_modern() +
  theme(axis.text.y = element_blank()) +
  # facet_wrap(~Participant) +
  labs(y = "", x = "Reaction Time (ms)")


df$Outlier <- df$RT < 150 | df$RT > 3000

p2 <- df |>
  group_by(Participant) |>
  summarize(Outlier = sum(Outlier) / n()) |>
  mutate(Participant = fct_reorder(Participant, Outlier)) |>
  ggplot(aes(x = Participant, y = Outlier)) +
  geom_bar(stat = "identity", aes(fill = Participant)) +
  scale_fill_material_d("rainbow", guide = "none") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent) +
  see::theme_modern() +
  theme(axis.text.x = element_blank())

p1 | p2
```

We removed `r sum(df$Outlier)` (`r insight::format_value(sum(df$Outlier) / nrow(df), as_percent=TRUE)`) outlier trials (150 ms < RT < 3000 ms).

```{r message=FALSE, warning=FALSE}
df <- filter(df, Outlier == FALSE)
```




## Participants



```{r message=FALSE, warning=FALSE}
dfsub <- df |>
  group_by(Participant) |>
  select(Participant, Age, Sex, Education, Nationality, Ethnicity, Duration, Break_Duration, Screen_Resolution, Screen_Refresh, Device_OS) |>
  slice(1) |>
  ungroup()
```

The final sample included `r report::report_participants(dfsub, age="Age", sex="Sex")`.

```{r }
plot_distribution <- function(dfsub, what = "Age", title = what, subtitle = "", fill = "orange") {
  dfsub |>
    ggplot(aes_string(x = what)) +
    geom_density(fill = fill) +
    geom_vline(xintercept = mean(dfsub[[what]]), color = "red", linetype = "dashed") +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    ggtitle(title, subtitle = subtitle) +
    theme_modern() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(face = "italic", hjust = 0.5),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.y = element_blank()
    )
}

plot_waffle <- function(dfsub, what = "Nationality") {
  ggwaffle::waffle_iron(dfsub, what) |>
    # mutate(label = emojifont::fontawesome('fa-twitter')) |>
    ggplot(aes(x, y, fill = group)) +
    ggwaffle::geom_waffle() +
    # geom_point() +
    # geom_text(aes(label=label), family='fontawesome-webfont', size=4) +
    coord_equal() +
    ggtitle(what) +
    labs(fill = "") +
    theme_void() +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
}
```

```{r fig.width=20, fig.height=15}
p1 <- plot_distribution(dfsub, "Age", fill = "#FF9800")
p2 <- plot_distribution(dfsub, "Duration", title = "Total Duration", subtitle = "in minutes", fill = "#F44336")
p3 <- plot_distribution(dfsub, "Break_Duration", title = "Break Duration", subtitle = "in minutes", fill = "#3F51B5")

p4 <- plot_waffle(dfsub, "Sex") +
  scale_fill_manual(values = c("Male" = "#2196F3", "Female" = "#E91E63", "Other" = "#FF9800"))

p5 <- plot_waffle(dfsub, "Education") +
  scale_fill_viridis_d()

p6 <- plot_waffle(dfsub, "Nationality") +
  scale_fill_metro_d()

p7 <- plot_waffle(dfsub, "Ethnicity") +
  scale_fill_manual(values = c("Latino" = "#FF5722", "Asian" = "#FF9800", "Caucasian" = "#2196F3", "African" = "#4CAF50", "Jewish" = "#9C27B0"))

p8 <- plot_waffle(dfsub, "Screen_Resolution") +
  scale_fill_pizza_d()

p9 <- plot_waffle(dfsub, "Device_OS") +
  scale_fill_bluebrown_d()

# p10 <- plot_waffle(dfsub, "Screen_Refresh") +
#   scale_fill_viridis_d()


(p1 / p2 / p3) | (p4 / p5 / p6) | (p7 / p8 / p9)
```



# Results


## Delboeuf


### Descriptive

```{r message=FALSE, warning=FALSE, cache=cache}
plot_descriptive <- function(data, side="leftright") {
  
  if(side == "leftright") {
    x <- data[data$Error == 0 & data$Illusion_Side == 1, ]$Answer[1]
    x <- tools::toTitleCase(gsub("arrow", "", x))
    if(x == "Left") data$Answer <- ifelse(data$Illusion_Side == 1, "Left", "Right")
  }
  
  dodge1 <- 0.1 * diff(range(data$Illusion_Difference))
  dodge2 <- -0.1 * diff(range(data$Illusion_Strength))
  
  colors <- colorRampPalette(c("#4CAF50", "#009688", "#00BCD4", "#2196F3", "#3F51B5", "#673AB7", "#9C27B0"))(length(unique(data$Illusion_Strength)))
  
  p1 <- data |> 
    group_by(Illusion_Difference, Illusion_Strength, Answer) |> 
    summarize(Error = mean(Error)) |> 
    mutate(Illusion_Strength = as.factor(Illusion_Strength)) |> 
    ggplot(aes(x = Illusion_Difference, y = Error)) +
    geom_bar(aes(fill=Illusion_Strength), position = position_dodge(width=dodge1), stat="identity") +
    geom_line(aes(color = Illusion_Strength), position = position_dodge(width=dodge1)) +
    scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_color_manual(values = colors) +
    scale_fill_manual(values = colors) +
    theme_modern() +
    labs(
      color = "Illusion Strength", fill = "Illusion Strength",
      y = "Probability of Error",
      x = "Task Difficulty"
    ) +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
  
  colors <- colorRampPalette(c("#F44336", "#FFC107", "#4CAF50"))(length(unique(data$Illusion_Difference)))
    
  p2 <- data |> 
    group_by(Illusion_Difference, Illusion_Strength, Answer) |> 
    summarize(Error = mean(Error)) |> 
    mutate(Illusion_Difference = as.factor(round(Illusion_Difference, 2))) |> 
    ggplot(aes(x = Illusion_Strength, y = Error)) +
    geom_bar(aes(fill=Illusion_Difference), position = position_dodge(width=dodge2), stat="identity") +
    geom_line(aes(color = Illusion_Difference), position = position_dodge(width=dodge2)) +
    scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_color_manual(values = colors) +
    scale_fill_manual(values = colors) +
    theme_modern() +
    labs(
      color = "Task Difficulty", fill = "Task Difficulty",
      y = "Probability of Error",
      x = "Illusion Strength"
    ) +
    theme(plot.title = element_text(face = "bold", hjust = 0.5)) 
  
  if(side == "leftright") {
    p <- ((p1 + facet_wrap(~Answer, ncol=2, labeller = "label_both")) /
      (p2 + facet_wrap(~Answer, ncol=2, labeller = "label_both"))) + 
    plot_annotation(title = "Delboeuf Illusion", 
                    theme = theme(plot.title = element_text(face = "bold", hjust = 0.5)))
  }
  p
}

data <- filter(df, Illusion_Type == "Delboeuf")

plot_descriptive(data)
```

### Model Selection

```{r message=FALSE, warning=FALSE, cache=cache}
models <- list()
for(i in 1:3) {
  for(j in 1:3) {
    m <- glmmTMB::glmmTMB(
      Error ~ poly(Illusion_Difference, i) * poly(Illusion_Strength, j) + 
        (1 | Participant),
      data = data,
      family = "binomial"
      )
    if(performance::check_convergence(m)) {
      models[[paste0("dif", i, "-str", j)]] <- m
    }
    # m <- glmmTMB::glmmTMB(
    #   Error ~ poly(log(Illusion_Difference), i) * poly(Illusion_Strength, j) + 
    #     (1 | Participant),
    #   data = data,
    #   family = "binomial"
    #   )
    # if(performance::check_convergence(m)) {
    #   models[[paste0("dif(log(", i, "))-str", j)]] <- m
    # }
    m <- glmmTMB::glmmTMB(
      Error ~ Illusion_Side * poly(Illusion_Difference, i) * poly(Illusion_Strength, j) + 
        (1 | Participant),
      data = data,
      family = "binomial"
      )
    if(performance::check_convergence(m)) {
      models[[paste0("side-dif", i, "-str", j)]] <- m
    }
  }
}

test <- test_performance(models, reference=3)
perf <- compare_performance(models, metrics = c("BIC", "R2")) 

merge(perf, test) |> 
  arrange(BIC) |> 
  select(Name, BIC, R2_marginal, BF) |> 
  mutate(BF = insight::format_bf(BF, name=""))
```

### Model

```{r message=FALSE, warning=FALSE, cache=cache}
formula <- brms::bf(
  Error ~ Illusion_Difference * poly(Illusion_Strength, 2) + 
    (1 | Participant),
  family = "bernoulli"
)

model <- brms::brm(formula,
  data = data,
  algorithm = "meanfield",
  refresh = 0
)
```


```{r message=FALSE, warning=FALSE, cache=cache}
plot_model <- function(data, model) {
  data <- mutate(data, .dots_side = ifelse(Error == 1, "bottom", "top"))
  
  n_lines <- 5
  pred <- estimate_relation(model,
                            at = c("Illusion_Strength", "Illusion_Difference"),
                            length = c(5, n_lines)) |>
    mutate(Illusion_Difference = as.factor(round(Illusion_Difference, 2)))
  
  # Set colors for lines
  colors <- colorRampPalette(c("#F44336", "#FFC107", "#4CAF50"))(n_lines)
  diffvals <- as.numeric(as.character(unique(sort(pred$Illusion_Difference))))
  names(colors) <- diffvals
  
  # Assign color from the same palette to every observation of data (for geom_dots)
  data$color <- colors[as.character(diffvals[max.col(-abs(outer(data$Illusion_Difference, diffvals, "-")))])]
  
  # Manual jittering
  xrange <- 0.05*diff(range(data$Illusion_Strength))
  data$x <- data$Illusion_Strength 
  data$x[data$x > 0] <- data$x[data$x > 0] - runif(sum(data$x > 0), 0, xrange)
  data$x[data$x < 0] <- data$x[data$x < 0] + runif(sum(data$x < 0), 0, xrange)
  data$x[round(data$x, 2) == 0] <- data$x[round(data$x, 2) == 0] + runif(sum(round(data$x, 2) == 0), -xrange/2, xrange/2)
  
  
  pred |>
    ggplot(aes(x = Illusion_Strength, y = Predicted)) +
    geom_dots(
      data = mutate(data, 
                    Illusion_Strength = round(Illusion_Strength, 1)),
      aes(x=x, y = Error, group = Error, side = .dots_side), 
      fill = data$color,
      color = NA, 
      alpha=0.5) +
    geom_slab(data=data, aes(y = Error)) +
    geom_ribbon(aes(ymin = CI_low, ymax = CI_high, fill = Illusion_Difference, group = Illusion_Difference), alpha = 0.2) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_hline(yintercept = c(0.05, 0.5, 0.95), linetype = "dotted", alpha = 0.5) +
    geom_line(aes(color = Illusion_Difference, group = Illusion_Difference)) +
    scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_color_manual(values = colors) +
    scale_fill_manual(values = colors) +
    coord_cartesian(xlim=c(min(data$Illusion_Strength), max(data$Illusion_Strength))) +
    theme_modern() +
    labs(
      title = paste0(data$Illusion_Type[1], " Illusion"),
      color = "Difficulty", fill = "Difficulty",
      y = "Probability of Error",
      x = "Illusion Strength"
    ) +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
}

plot_model(data, model)
```






### Parameter 




























## Manipulation Checks {.tabset}

### Illusion Side

We tested whether at illusion strength = 0, no effect of right / left (no bias of illusion at 0).

```{r message=FALSE, warning=FALSE}
model <- glmmTMB::glmmTMB(Error ~ Illusion_Type / Illusion_Side + (1 | Participant),
  data = filter(df, Illusion_Strength == 0),
  family = "binomial"
)

parameters(model, effects = "fixed") |>
  tail(10) |> 
  arrange(p)

# select(filter(df, Error == 0, Illusion_Type == "Müller-Lyer"), Illusion_Side, Answer)
# select(filter(df, Error == 0, Illusion_Type == "Vertical-Horizontal"), Illusion_Side, Answer)
# select(filter(df, Error == 0, Illusion_Type == "Zöllner"), Illusion_Side, Answer)
```

Müller-Lyer: when no illusion, it is easier to answer that the upper line is longer.

### ISI

```{r message=FALSE, warning=FALSE}
model <- glmmTMB::glmmTMB(Error ~ Illusion_Type / poly(ISI, 2) + (1 | Participant),
  data = df,
  family = "binomial"
)

parameters(model, effects = "fixed") |>
  tail(20)

# select(filter(df, Error == 0, Illusion_Type == "Müller-Lyer"), Illusion_Side, Answer)
# select(filter(df, Error == 0, Illusion_Type == "Vertical-Horizontal"), Illusion_Side, Answer)
# select(filter(df, Error == 0, Illusion_Type == "Zöllner"), Illusion_Side, Answer)
```

## Full Models


### Errors {.tabset}




##### Ebbinghaus

###### Model Selection


```{r message=FALSE, warning=FALSE, cache=cache}
data <- filter(df, Illusion_Type == "Delboeuf")

models <- list()
for(i in 1:3) {
  for(j in 1:3) {
    m <- glmmTMB::glmmTMB(
      Error ~ poly(Illusion_Difference, i) * poly(Illusion_Strength, j) + 
        (1 | Participant),
      data = data,
      family = "binomial"
      )
    if(performance::check_convergence(m)) {
      models[[paste0("dif", i, "-str", j)]] <- m
    }
    m <- glmmTMB::glmmTMB(
      Error ~ poly(log(Illusion_Difference), i) * poly(Illusion_Strength, j) + 
        (1 | Participant),
      data = data,
      family = "binomial"
      )
    if(performance::check_convergence(m)) {
      models[[paste0("dif(log(", i, "))-str", j)]] <- m
    }
    m <- glmmTMB::glmmTMB(
      Error ~ poly(sqrt(Illusion_Difference), i) * poly(Illusion_Strength, j) + 
        (1 | Participant),
      data = data,
      family = "binomial"
      )
    if(performance::check_convergence(m)) {
      models[[paste0("dif(sqrt(", i, "))-str", j)]] <- m
    }
  }
}

compare_performance(models, metrics = c("BIC", "R2")) |> 
  merge(test_performance(models, reference=6)) |> 
  arrange(BIC) |> 
  select(Name, BIC, R2_marginal, BF) |> 
  mutate(BF = insight::format_bf(BF, name=""))
```



```{r message=FALSE, warning=FALSE}
model_errors <- function(df, illusion = "Delboeuf") {
  data <- filter(df, Illusion_Type == illusion) |>
    mutate(.dots_side = ifelse(Error == 1, "bottom", "top"))

  if (illusion == "Müller-Lyer") {
    formula <- brms::bf(
      # Error ~ t2(Illusion_Difference, Illusion_Strength, k = 4) + (1 | Participant),
      # Error ~ s(Illusion_Strength, by=Illusion_Difference, k = 7) + (1 | Participant),
      Error ~ poly(Illusion_Difference, 3) * poly(Illusion_Strength, 3) * Illusion_Side + 
        (1 | Participant),
      family = "bernoulli"
    )
  } else {
    formula <- brms::bf(
      # Error ~ t2(Illusion_Difference, Illusion_Strength, k = 4) + (1 | Participant),
      # Error ~ s(Illusion_Strength, by=Illusion_Difference, k = 7) + (1 | Participant),
      Error ~ poly(Illusion_Difference, 3) * poly(Illusion_Strength, 3) + 
        (1 | Participant),
      family = "bernoulli"
    )
  }

  model <- brms::brm(formula,
    data = data,
    algorithm = "meanfield",
    refresh = 0
  )
  
  # model <- glmmTMB::glmmTMB(
  #   Error ~ Illusion_Difference * Illusion_Strength + (1 | Participant),
  #   data = data,
  #   family = "binomial"
  # )
  # model <- mgcv::gamm(
  #   # Error ~ s(Illusion_Difference, by = Illusion_Strength, k = 4),
  #   Error ~ t2(Illusion_Difference, Illusion_Strength, k = 4),
  #   random = list(Participant = ~1),
  #   data = data,
  #   family = "binomial"
  # )
  # model <- glmmTMB::glmmTMB(
  #   # Error ~ s(Illusion_Difference, by = Illusion_Strength, k = 4),
  #   Error ~ poly(Illusion_Difference, 2) * poly(Illusion_Strength, 2) * Illusion_Side + (1 | Participant),
  #   data = data,
  #   family = "binomial"
  # )

  n_lines <- 5
  pred <- estimate_relation(model,
                            at = c("Illusion_Strength", "Illusion_Difference"),
                            # at = list(Illusion_Strength = unique(data$Illusion_Strength), Illusion_Difference = unique(data$Illusion_Difference)), 
                            length = c(5, n_lines)) |>
    mutate(
      Illusion_Difference = as.factor(Illusion_Difference),
      Illusion_Type = illusion
    )
  
  # Set colors for lines
  colors <- colorRampPalette(c("#F44336", "#FFC107", "#4CAF50"))(n_lines)
  diffvals <- as.numeric(as.character(unique(sort(pred$Illusion_Difference))))
  names(colors) <- diffvals
  
  # Assign color from the same palette to every observation of data (for geom_dots)
  data$color <- colors[as.character(diffvals[max.col(-abs(outer(data$Illusion_Difference, diffvals, "-")))])]
  
  # Manual jittering
  xrange <- 0.05*diff(range(data$Illusion_Strength))
  data$x <- data$Illusion_Strength 
  data$x[data$x > 0] <- data$x[data$x > 0] - runif(sum(data$x > 0), 0, xrange)
  data$x[data$x < 0] <- data$x[data$x < 0] + runif(sum(data$x < 0), 0, xrange)
  data$x[round(data$x, 2) == 0] <- data$x[round(data$x, 2) == 0] + runif(sum(round(data$x, 2) == 0), -xrange/2, xrange/2)
  
  
  p <- pred |>
    ggplot(aes(x = Illusion_Strength, y = Predicted)) +
    geom_dots(
      data = mutate(data, Illusion_Strength = round(Illusion_Strength, 1)),
      aes(x=x, y = Error, group = Error, side = .dots_side), fill = data$color,
      color = NA, alpha=0.5) +
    # geom_dots(
    #   data = mutate(data, Illusion_Strength = round(Illusion_Strength, 1)),
    #   aes(y = Error, group = Error, side = .dots_side),
    #   fill = ifelse(data$Error == 1, "red", "green"), color = NA, alpha=0.2,
    #   position = position_jitter(width=0.05*diff(range(data$Illusion_Strength)), height=0)
    # ) +
    geom_slab(data=data, aes(y = Error)) +
    geom_ribbon(aes(ymin = CI_low, ymax = CI_high, fill = Illusion_Difference, group = Illusion_Difference), alpha = 0.2) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_hline(yintercept = c(0.05, 0.5, 0.95), linetype = "dotted", alpha = 0.5) +
    geom_line(aes(color = Illusion_Difference, group = Illusion_Difference)) +
    scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_color_manual(values = colors) +
    scale_fill_manual(values = colors) +
    theme_modern() +
    labs(
      title = paste0(illusion, " Illusion"),
      color = "Difficulty", fill = "Difficulty",
      y = "Probability of Error",
      x = "Illusion Strength"
    ) +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))


  list(p = p, model = model, pred = pred)
}
```


## References
